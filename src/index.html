<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video call test</title>
</head>

<body>
  <video width="320" height="240"></video>
  <button id="start-call">Call</button>
  <button id="start-video">Start</button>
  <button id="stop-video">Stop</button>
  <script src="./simplepeer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>
  <script>
    // navigator.mediaDevices.getUserMedia({
    //   video: true,
    //   audio: true
    // }).then(gotMedia).catch(() => { })

    console.log(uuidv4());

    function gotMedia(stream) {
      var peer1 = new SimplePeer({ initiator: true, stream: stream })
      var peer2 = new SimplePeer()

      peer1.on('signal', data => {
        peer2.signal(data)
      })

      peer2.on('signal', data => {
        peer1.signal(data)
      })

      peer2.on('stream', stream => {
        // got remote video stream, now let's show it in a video tag
        var video = document.querySelector('video')

        if ('srcObject' in video) {
          video.srcObject = stream
        } else {
          video.src = window.URL.createObjectURL(stream) // for older browsers
        }
        video.play()
      })

      document.getElementById('stop-video').addEventListener('click', ev => {
        console.log('stopping video')
        ev.preventDefault()
        stopVideoOnly(stream)
      })
    }

    document.getElementById('start-video').addEventListener('click', ev => {
      ev.preventDefault()
      navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      }).then(gotMedia).catch(() => { })
    })

    // stop only camera
    function stopVideoOnly(stream) {
      stream.getTracks().forEach(function (track) {
        if (track.readyState == 'live' && track.kind === 'video') {
          track.stop();
        }
      });
      var video = document.querySelector('video')
      video.src = ''
    }

    // stop only mic
    function stopAudioOnly(stream) {
      stream.getTracks().forEach(function (track) {
        if (track.readyState == 'live' && track.kind === 'audio') {
          track.stop();
        }
      });
    }
  </script>
</body>

</html>